<!DOCTYPE html>
<html>
<head>
    <title>Cernak Lab - Isco Portal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; background: #fff; }
        .info-panel { line-height: 1.4; font-size: 14px; }
        .status-badge { padding: 4px 8px; border-radius: 12px; color: white; font-weight: bold; font-size: 12px; }
        .btn { display: block; text-align: center; padding: 8px; margin: 8px 0; border-radius: 5px; text-decoration: none; color: white; font-weight: bold; font-size: 13px; }
        .btn-status { background: #444; }
        .btn-ai { background: #6f42c1; }
        hr { border: 0; border-top: 1px solid #eee; margin: 10px 0; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        var map = L.map('map', { crs: L.CRS.Simple, minZoom: -1 });
        var bounds = [[0,0], [1080,1920]];
        L.imageOverlay('Cernak lab map.svg', bounds).addTo(map);
        map.fitBounds(bounds);

        var sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQr85kdlDb92TZR_iUJTT3Plry6-0Bc4n3di7fTQvT1A6cMRcPcVe-TIA8WCqJRa15udjsAeG9jdoi0/pub?output=csv';
        var editUrl = 'https://docs.google.com/spreadsheets/d/10DsQ---R2owVXBIlj2bMnjH3kB05bFl69PxMVVlC4dU/edit?gid=0#gid=0';

        function loadIsco() {
            Papa.parse(sheetUrl, {
                download: true,
                header: true,
                complete: function(results) {
                    var isco = results.data.find(row => row.Instrument === 'Isco');
                    
                    if (isco) {
                        var statusColor = isco.Status.trim().toLowerCase();
                        var steward = isco.Steward || "Unassigned"; // Fallback if empty
                        var lastPM = isco.Last_Calibrated || "Unknown";

                        // Using a larger radius for the circle so it's easy to see
                        var marker = L.circle([400, 300], {
                            radius: 35, 
                            fillColor: statusColor,
                            color: "#000",
                            weight: 2,
                            fillOpacity: 1
                        }).addTo(map);

                        marker.bindPopup(`
                            <div class="info-panel" style="width: 240px;">
                                <h2 style="margin:0 0 5px 0; font-size: 18px;">Isco Flash</h2>
                                <p style="margin: 5px 0;"><b>Status:</b> <span class="status-badge" style="background:${statusColor}">${statusColor.toUpperCase()}</span></p>
                                <p style="margin: 5px 0;"><b>Steward:</b> ${steward}</p>
                                <p style="margin: 5px 0; font-size: 11px; color: #666;">Last Service: ${lastPM}</p>
                                <hr>
                                <b style="font-size: 12px;">Documentation:</b>
                                <ul style="padding-left:18px; margin: 5px 0;">
                                    <li><a href="../instruments/isco-manual.pdf" target="_blank">PDF Manual</a></li>
                                    <li><a href="../instruments/isco-history.md" target="_blank">Maintenance History</a></li>
                                </ul>
                                <a href="${editUrl}" class="btn btn-status" target="_blank">Toggle Status (Red/Green)</a>
                                <a href="https://gemini.google.com" class="btn btn-ai" target="_blank">ðŸ¤– Ask AI Troubleshooting</a>
                            </div>
                        `);
                    }
                }
            });
        }
        loadIsco();

        map.on('click', function(e) {
            console.log("Clicked at: ", e.latlng.lat.toFixed(0), e.latlng.lng.toFixed(0));
        });
    </script>
</body>
</html>
