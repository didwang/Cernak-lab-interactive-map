<!DOCTYPE html>
<html>
<head>
    <title>Cernak Lab - Instrument Portal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; background: #fff; }

        #coord-display {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid #333;
            pointer-events: none;
        }
        
        #coord-tooltip {
            position: absolute;
            z-index: 1001;
            background: rgba(0,0,0,0.75);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            display: none;
        }

        
        /* Blinking Animation */
        @keyframes blink {
            0%   { opacity: 1;   stroke-width: 3; }
            50%  { opacity: 0.3; stroke-width: 8; }
            100% { opacity: 1;   stroke-width: 3; }
        }
        .blinking { animation: blink 1.5s infinite; }

        /* Information Panel Styling */
        .info-panel { line-height: 1.4; color: #000; }
        .status-badge { padding: 4px 10px; border-radius: 4px; color: white; font-weight: bold; font-size: 11px; }
        
        /* Button Styling */
        .btn { 
            display: block; text-align: center; padding: 12px; margin: 10px 0; border-radius: 6px; 
            text-decoration: none !important; color: #ffffff !important; 
            font-weight: 800; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .btn-manual  { background: #006064; }
        .btn-form    { background: #1b5e20; }
        .btn-history { background: #0d47a1; }
        .btn-status  { background: #212121; }
        .btn-ai      { background: #4a148c; }
        }
    </style>
</head>
<body>
    <!-- Map container (needed for Leaflet) -->
    <div id="map"></div>

    <!-- Coordinate UI -->
    <div id="coord-display" style="display:none;">Lat: ‚Äì, Lng: ‚Äì</div>
    <div id="coord-tooltip"></div>
    <div id="coord-tool" onclick="toggleCoordOverlay()"
         style="position:absolute; top:10px; right:10px; z-index:1000;
                background:white; padding:10px; border:2px solid #333;
                border-radius:8px; font-weight:bold; cursor:pointer;">
        üìç Show / Hide Coordinates
    </div>

    <script>
        // --- Map setup ---
        var map = L.map('map', { crs: L.CRS.Simple, minZoom: -1 });
        var bounds = [[0,0], [1080,1920]];
        L.imageOverlay('Cernak lab map.svg', bounds).addTo(map);
        map.fitBounds(bounds);
        map.setZoom(map.getZoom() + 0.6);
        map.whenReady(function () {
            setTimeout(function () { map.invalidateSize(); }, 0);
        });

        // --- URLs ---
        var sheetUrl   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQr85kdlDb92TZR_iUJTT3Plry6-0Bc4n3di7fTQvT1A6cMRcPcVe-TIA8WCqJRa15udjsAeG9jdoi0/pub?output=csv';
        var formUrl    = 'https://docs.google.com/forms/d/e/1FAIpQLSfvjJTJ1nLW-Eb3ZoEL_wix3h7kMm0SoqeJ5ndFaYjvagW-_Q/viewform?usp=dialog';
        var logViewUrl = 'https://docs.google.com/spreadsheets/d/10DsQ---R2owVXBIlj2bMnjH3kB05bFl69PxMVVlC4dU/edit#gid=1956041763';
        var editUrl    = 'https://docs.google.com/spreadsheets/d/10DsQ---R2owVXBIlj2bMnjH3kB05bFl69PxMVVlC4dU/edit#gid=0';
        var manualUrl  = 'https://drive.google.com';

        var aiLink = "https://gemini.google.com/app?prompt=" + encodeURIComponent(
            "I am troubleshooting an instrument in the Cernak Lab. Here are our logs..."
        );

        // --- Coordinate overlay & hover tooltip ---
        var coordOverlayActive = false;
        var coordDisplay = document.getElementById('coord-display');
        var coordTooltip = document.getElementById('coord-tooltip');

        function toggleCoordOverlay() {
            coordOverlayActive = !coordOverlayActive;
            var el = document.getElementById('coord-tool');

            if (coordOverlayActive) {
                el.style.background = '#ffeb3b';
                el.innerText = 'Hide Coordinates';
                coordDisplay.style.display = 'block';
                coordTooltip.style.display = 'block';
            } else {
                el.style.background = 'white';
                el.innerText = 'üìç Show / Hide Coordinates';
                coordDisplay.style.display = 'none';
                coordTooltip.style.display = 'none';
            }
        }

        map.on('mousemove', function(e) {
            if (!coordOverlayActive) return;
            var lat = Math.round(e.latlng.lat);
            var lng = Math.round(e.latlng.lng);
            coordDisplay.textContent = 'Lat: ' + lat + ', Lng: ' + lng;
            coordTooltip.style.left = (e.originalEvent.clientX + 12) + 'px';
            coordTooltip.style.top  = (e.originalEvent.clientY + 12) + 'px';
            coordTooltip.textContent = '[' + lat + ', ' + lng + ']';
        });
        map.on('mouseout', function() {
            if (!coordOverlayActive) return;
            coordTooltip.style.display = 'none';
        });
        map.on('mouseover', function() {
            if (!coordOverlayActive) return;
            coordTooltip.style.display = 'block';
        });

        // --- Instrument ‚Üí Coordinate lookup ---
        var instrumentCoords = {
            "SPS":         [204, 418],
            "Nile":        [268, 1364],
            "Ganges":      [428, 1364],
            "Colorado":    [486, 1714],
            "NUB GB":      [542, 1714],
            "Huanghe":     [302, 1442],
            "ISCO":        [188, 120],
            "Chem GB 3608": [428, 560],
            "Chem GB 3622": [428, 1224],
            "Mosquito 3608": [244, 560],
            "Mosquito 3622": [244, 1224],
            "Genevec":     [290, 474],
            "Huron":       [428, 418],
            "GCMS":        [428, 474],
            "Biotage":     [428, 1150],
            "Lyophilizer": [268, 1310],
            "Opentrons 3608": [332, 560],
            "Opentrons 3622": [332, 1224],
            "Opentrons NUB":  [424, 1792],
            "-80 Freezer":    [424, 1714],
            "Incubator1":      [370, 1714]
        };

        // --- Instrument ‚Üí Manual link(s) ---
        var instrumentManuals = {
            "SPS": [
                "https://drive.google.com/file/d/1az_PkpDrI7GcyUPt36Xc6-Z9otGAOvVY/view?usp=drive_link",
                "https://drive.google.com/file/d/1sxfTFN3MHrXOBFdjUpWOIhIQdNwG8vvc/view?usp=drive_link"
            ],
            "Nile": [
                "https://drive.google.com/drive/folders/1BKjJaSgfSx-X4RPJ_Y1g1jkcLUg7QU0q?usp=drive_link",
                "https://support.waters.com/"
            ],
            "Colorado": [
                "https://drive.google.com/drive/folders/1BKjJaSgfSx-X4RPJ_Y1g1jkcLUg7QU0q?usp=drive_link",
                "https://support.waters.com/"
            ],
            "NUB GB": [
                "https://drive.google.com/file/d/192DI5hqAE_6YMnVLUD8KKqgkm817eFUE/view?usp=drive_link"
            ],
            "Huanghe": [
                "https://drive.google.com/drive/folders/1BKjJaSgfSx-X4RPJ_Y1g1jkcLUg7QU0q?usp=drive_link",
                "https://support.waters.com/"
            ],
            "Ganges": [
                "https://drive.google.com/drive/folders/1BKjJaSgfSx-X4RPJ_Y1g1jkcLUg7QU0q?usp=drive_link",
                "https://support.waters.com/"
            ],
            "ISCO": [
                "https://drive.google.com/file/d/1pZUCCT8Y-una-oyYfK-K-2UNrPt1HCpV/view?usp=drive_link"
            ],
            "Chem GB 3608": [
                "https://drive.google.com/drive/folders/1EAglpuvopoLHl73tCfOetszpCy71HuNx?usp=drive_link"
            ],
            "Chem GB 3622": [
                "https://drive.google.com/drive/folders/1EAglpuvopoLHl73tCfOetszpCy71HuNx?usp=drive_link"
            ],
            "Mosquito 3608": [],
            "Mosquito 3622": [],
            "Genevec": [
                "https://drive.google.com/file/d/1cxVRDt7AXgNPFuCWhYaBdkVi1pRgxYk0/view?usp=drive_link"
            ],
            "Huron": [
                "https://drive.google.com/drive/folders/1BKjJaSgfSx-X4RPJ_Y1g1jkcLUg7QU0q?usp=drive_link",
                "https://support.waters.com/"
            ],
            "GCMS": [
                "https://drive.google.com/drive/folders/1LatZ9ZLV9Z1pYV2TxlQ4qgA6OCcWOtfy?usp=drive_link"
            ],
            "Biotage": [
                "https://drive.google.com/file/d/13rkzjcJ8HW-O1_WdjwPpiVFGDmae4drl/view?usp=drive_link",
                "https://docs.google.com/presentation/d/1l5ts39j3450PBawkgf-sMZScXw9k4Nct/edit?usp=drive_link&ouid=107419069231728235617&rtpof=true&sd=true"
            ],
            "Lyophilizer": [
                "https://drive.google.com/file/d/1t5MRqCULVYypT-eEwCLStKRmEIubpfLQ/view?usp=drive_link"
            ],
            "Opentrons 3608": [
                "https://drive.google.com/file/d/1GG8CAH-yNrn5RVy2S9o5r4uLvg99KS30/view?usp=drive_link"
            ],
            "Opentrons 3622": [
                "https://drive.google.com/file/d/1GG8CAH-yNrn5RVy2S9o5r4uLvg99KS30/view?usp=drive_link"
            ],
            "Opentrons NUB": [
                "https://drive.google.com/file/d/1GG8CAH-yNrn5RVy2S9o5r4uLvg99KS30/view?usp=drive_link"
            ],
            "-80 Freezer": [
                "https://docs.google.com/presentation/d/1dLDj9HQh0ydgNgOI9aLnikLbxeglklSB/edit?usp=drive_link&ouid=107419069231728235617&rtpof=true&sd=true"
            ],
            "Incubator": [
                "https://drive.google.com/file/d/1GhmEZLPWvbDujJFotJk7iAm88qQDBKfw/view?usp=drive_link",
                "https://drive.google.com/file/d/139GIkDT56jGvM7lDMfLS0FY9c5S9jRLh/view?usp=drive_link"
            ]
        };

        function loadInstruments() {
            Papa.parse(sheetUrl, {
                download: true,
                header: true,
                complete: function(results) {
                    results.data.forEach(function(row) {
                        var name = (row.Instrument || "").trim();
                        if (!name) return;
                        if (!instrumentCoords[name]) return;

                        var coords    = instrumentCoords[name];
                        var statusRaw = (row.Status || "").trim().toLowerCase();
                        var steward   = row.Steward || "Unassigned";
                        var lastCal   = row.Last_Calibrated || "N/A";
                        var nextPM    = row.Next_PM_Due || "N/A";
                        var comment   = row.Comment || "N/A";

                        var statusColor = statusRaw === "green" ? "green" : "red";
                        var className   = statusColor === "red" ? "blinking" : "";

                        var manuals = instrumentManuals[name] || [];
                        var manualButtons = "";

                        if (manuals.length === 0) {
                            manualButtons = `
                                <a href="${manualUrl}" class="btn btn-manual" target="_blank">
                                    üìñ VIEW MANUAL
                                </a>`;
                        } else if (manuals.length === 1) {
                            manualButtons = `
                                <a href="${manuals[0]}" class="btn btn-manual" target="_blank">
                                    üìñ VIEW MANUAL
                                </a>`;
                        } else {
                            manualButtons = `
                                <a href="${manuals[0]}" class="btn btn-manual" target="_blank">
                                    üìñ VIEW MANUAL
                                </a>
                                <a href="${manuals[1]}" class="btn btn-manual" target="_blank">
                                    üìé EXTRA DOC
                                </a>`;
                        }

                        var fill = statusColor === "green" ? "#5ec962" : "#f8765c";

                        var marker = L.circle(coords, {
                            radius: 13,
                            fillColor: fill,
                            color: "transparent",
                            weight: 0,
                            fillOpacity: 0.9,
                            className: className
                        }).addTo(map);

                        marker.bindPopup(`
                            <div class="info-panel" style="width: 260px;">
                                <h2 style="margin:0 0 10px 0;">${name}</h2>
                                <p><b>Status:</b> 
                                    <span class="status-badge" style="background:${fill}">
                                        ${statusColor.toUpperCase()}
                                    </span>
                                </p>
                                <p><b>Steward:</b> ${steward}</p>
                                <p><b>Last calibrated:</b> ${lastCal}</p>
                                <p><b>Next PM due:</b> ${nextPM}</p>
                                <p><b>Comment:</b> ${comment}</p>
                                <hr>
                                ${manualButtons}
                                <a href="${formUrl}" class="btn btn-form" target="_blank">‚ûï ADD LOG ENTRY</a>
                                <a href="${logViewUrl}" class="btn btn-history" target="_blank">üìú VIEW HISTORY LOG</a>
                                <hr>
                                <a href="${editUrl}" class="btn btn-status" target="_blank">CHANGE RED/GREEN</a>
                                <a href="${aiLink}" class="btn btn-ai" target="_blank">ü§ñ ASK AI ASSISTANT</a>
                            </div>
                        `);
                    });
                }
            });
        }

        loadInstruments();
    </script>
</body>

</html>
